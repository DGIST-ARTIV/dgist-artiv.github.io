---
date: 2020-05-03 13:00:00
layout: post
title: RTK-GNSS Test & Setting [Part 2]
subtitle: RTK-GNSS 테스트 및 세팅
description: RTK-GNSS 테스트 및 세팅
image: http://img.youtube.com/vi/WMBXHukpKNY/0.jpg
category: hdmap
tags:
  - autonomous
  - localization
  - RTK_GNSS
author: junsang
---
연구 초창기에 RTK-GNSS를 테스트하고 세팅한 과정을 기록하고 있다.  
[Part 1 보러가기(클릭)](https://dgist-artiv.github.io/hdmap/2020/04/30/RTK-test.html)

이번 Part에서는 nmea를 파싱하고 ros topic으로 publish해주는 driver를 이용해보고, mapviz를 이용한 시각화를 진행한 내용을 설명하고자 한다.

모든 환경은 ROS-melodic, Ubuntu 18.04를 기준으로 테스트 되었다.

### 1. ROS NMEA Driver 사용해보기  
NMEA는 시간, 위치, 방위 등의 정보를 전달하는 규격 중 하나이다.

다행히도, ROS에서 nmea 값을 값을 파싱하고 publish해주는 패키지가 존재한다.

우리가 이용할 드라이버는 [nmea_navsat_driver](http://wiki.ros.org/nmea_navsat_driver)이다.

#### How to install  
    $ sudo apt-get install ros-melodic-nmea-navsat-driver

apt-get을 이용하여 손쉽게 설치할 수 있다.

#### How to run  
    $ rosrun nmea_navsat_driver nmea_serial_driver _port:=/dev/ttyUSB0 _baud:=115200  
    
MRP-2000이 지원하는 baudrate가 115200이기 때문에 `_baud:=115200` 라는 조건을 붙였다.  
기기가 어떤 포트에 연결되었는지에 따라 `_port:=/dev/ttyUSB0` 에서 `ttyUSB0` 부분을 맞게 수정해주면 된다.

#### 아마 에러가 날 것이다.  
    [FATAL] [1587321012.247533]: Could not open serial port: I/O error(13): could not open port /dev/ttyUSB0: [Errno 13] Permission denied: '/dev/ttyUSB0'

근데 포트를 open할 수 있는 권한이 주어져 있지 않아 에러가 발생한다.  
`$ sudo chmod 666 /dev/ttyUSB0`  
chmod로 권한을 주어 해결할 수 있다.

근데 chmod의 경우 재부팅을 할 때마다 재입력을 해주어야한다.
`$ sudo usermod -a -G dialout $USER`

위 구문을 통해 영구적으로 권한을 줄 수 있다. 처음엔 이 방법을 이용하였었는데, 나중엔 symlink를 통하여 해결하였다.  
symlink와 관련해서는 추후에 다른 글로 설명해보겠다.

아무튼 권한을 준 후에 다시 rosrun하면 정상적으로 실행될 것이다.

#### 어떤 topic들이 발행되나요?  
- fix (sensor_msgs/NavSatFix)
- vel (geometry_msgs/TwistStamped)
- time_reference (sensor_msgs/TimeReference)

위와 같은 topic들이 발행됩니다.

topic name을 통해서 어느정도 예측은 되시겠지만, 자세한 설명을 보고 싶다면 [nmea_navsat_driver](http://wiki.ros.org/nmea_navsat_driver)위키를 참고하세요!

뭐..일단 초기 테스트에서는 위치정보를 담고 있는 `/fix`만 이용하였다.

rostopic echo를 통해 `/fix`에서 발행되고 있는 값을 한 번 보자.  
`$ rostopic echo /fix`
    
살펴보면 latitude, longitude, altitude가 보이는데 당연히 요걸로 위치를 파악할 수 있다.
3개는 전부 float64 타입이다.

근데 저 숫자들을 보고 우리가 어디에 있는지 상상할 수 있는가?
개인적으로 불편해서 점 찍어주는 방법을 찾아봤다.

그 해답은 [mapviz](http://wiki.ros.org/mapviz/Plugins)에 있었다.

### 2. M

Mapviz는 ROS 기반의 visualization tool이다.

### How to install

    $ sudo apt-get install ros-melodic-mapviz ros-melodic-mapviz-plugins ros-melodic-tile-map ros-melodic-multires-image
    
### How to run

    $ roslaunch mapviz mapviz.launch

창이 하나 떴을 것이다.

하단의 Add를 눌러서, tile_map을 추가하자.
말 그대로, tile map을 띄워주는 것인데 기본값은 Stamen (terrain)이다. 근데 이게 한국에서만 그런지 몰라도, 일정 수준 이상으로 확대하면 네트워크 에러를 뿜으며 작동하지 않는다. 나중에 구글 위성지도로 교체할 것이다.
일단 테스트만 해보자.

또 Add를 눌러서, navsat를 불러오자.
Topic 옆에 Select를 눌러서 /fix를 추가한다.

Draw Style을 points로 바꾸고, 지도를 열심히 옮겨 대한민국을 찾고 대구를 찾아 현풍으로 확대해보자.
아까도 말했듯이 일정수준 이상으로 확대를 못한다... 대충 된다는 것만 보자.
점이 영롱하게 현풍에 찍힌다!

### 구글 위성지도로 교체(optional)

Mapviz에서는 WMTS를 이용하는데, 더 좋은 지도가 있으면 그걸 쓸거다.
일단 지금으로써는 구글 위성지도만 작동을 확인해서 이걸로 했다.

#### STEP 1

    $ mkdir ~/mapproxy
    $ sudo docker run -p 8080:8080 -d -t -v ~/mapproxy:/mapproxy danielsnider/mapproxy
    
아, 근데 Docker가 설치되어 있어야한다.
없으면 설치하고 오자. 나는 [이거][thislink]보고 깔았다.

[thislink]: https://blog.cosmosfarm.com/archives/248/%EC%9A%B0%EB%B6%84%ED%88%AC-18-04-%EB%8F%84%EC%BB%A4-docker-%EC%84%A4%EC%B9%98-%EB%B0%A9%EB%B2%95/

#### STEP 2

Mapviz를 열고, tile_map의 Sources에서 Custom WMTS Source...를 누르자.
Base URL에 아래의 구문을 입력 후, Max Zoom은 19로 설정한 뒤 Save한다.

    http://localhost:8080/wmts/gm_layer/gm_grid/{level}/{x}/{y}.png

쨘! 그럼 구글 위성지도가 뜨고 확대도 아주 잘 된다~


#### 참고자료

https://wiki.ros.org/nmea_navsat_driver

https://autoware.readthedocs.io/en/feature-documentation_rtd/DevelopersGuide/PackagesAPI/sensing/scripts.html

https://www.youtube.com/watch?v=zTrzr5BhH-8

https://blog.naver.com/chandong83/220780876639

http://wiki.ros.org/mapviz/Plugins

https://github.com/swri-robotics/mapviz/blob/master/README.md

https://github.com/solosito/MapViz-Tile-Map-Google-Maps-Satellite

https://blog.cosmosfarm.com/archives/248/%EC%9A%B0%EB%B6%84%ED%88%AC-18-04-%EB%8F%84%EC%BB%A4-docker-%EC%84%A4%EC%B9%98-%EB%B0%A9%EB%B2%95/




[![Video1](http://img.youtube.com/vi/WMBXHukpKNY/0.jpg)](https://youtu.be/WMBXHukpKNY)



본격적인 연구를 시작하기에 앞서, 어쩌다보니 GPS 장비의 관리 및 운용을 맡게 되었다.

RTK-GNSS를 테스트하고 세팅한 과정을 기록할 것이고, 본 내용은 몇 개의 파트로 나눠서 올릴 예정이다. (대략 2~3개 정도?)

### 우리의 장비

우리가 사용하는 RTK-GNSS 장비는 '씨너렉스'사의 'MRP-2000'이다.
![image1](https://user-images.githubusercontent.com/50894726/103692631-61ab9900-4fdb-11eb-8c7d-96b8c7bc1ae6.jpg){: width="300" height="300"}

보다시피 매우 작고 귀엽지만, 가격은 그렇지 못하니 다룰 때 조심해야할 필요가 있다.

5pin 마이크로 usb를 이용하여 5V 2A를 전원으로 공급받고, 9pin D-sub 단자(RS232)를 이용하여 NMEA 데이터를 출력한다.

DMB 신호나 LTE 신호를 받아 위치 정보를 보정하는 RTK 기술이 탑재되어 있다.

본 연구팀이 출전하는 대회(2020 국제 대학생 창작 자동차 경진대회)는 DMB 신호를 통한 보정을 금하고 있기에, LTE 모드로 사용하였다.

### 정확성 테스트

이 GPS를 연구에 사용하기에 앞서, 여기서 출력해주는 값이 얼마나 정확한지 확인할 필요가 있었다.

여러가지 방법을 생각해보다가, '측량기준점'정보를 이용하여 확인해보기로 하였다.

DGIST 근처에는 총 3개 정도의 기준점이 있었고, 가장 가까운 곳부터 하나씩 차례로 시도해보았다.

#### 1. DGIST 내 운동장 쪽 삼각점

![image2](https://user-images.githubusercontent.com/50894726/103698221-5c9f1780-4fe4-11eb-8b94-5ab2885c947a.jpg)

학교 안에 있어서 정말 좋아햇는데... 도저히 사람이 갈 수 없는 산길이였다.

도깨비 풀만 옷과 신발에 잔뜩묻고 fail.


#### 2. 달성경찰서 내 수준점

![image4](https://user-images.githubusercontent.com/50894726/103698225-5e68db00-4fe4-11eb-9e70-93e84816095b.jpg)

어떻게 오셨냐는 의경? 경찰?분의 말씀에 수준점 보러 왔다고 하니, 어디에 있는지 친절하게 말씀해주셨다.

사진처럼 수준점 위에 안테나를 올리고 위도, 경도 좌표를 따왔다.

![image6](https://user-images.githubusercontent.com/50894726/103696602-fb764480-4fe1-11eb-8dc0-768d2f6da11a.png)

그런데,, 문서상에 기재되어 있는 수준점의 좌표가 정확하지 않는 듯 하다.

측정한 위도, 경도 좌표를 구글맵에 띄워보면 수준점 위치랑 맞는 듯은 한데, 문서상의 좌표 위치가 전혀 딴판이라 정확성 검증을 해볼 수가 없었다.

아무래도 담당자께서 좌표의 소수점 이하를 지우시고 올린 듯 하다.

아무튼 그래서 fail.

#### 3. 유가읍 어딘가에 있는 수준점

다행히 어느정도 가까운 곳에 수준점이 하나 더 남아있었다.

![image7](https://user-images.githubusercontent.com/50894726/103698340-8fe1a680-4fe4-11eb-9226-782f725bb17b.jpg)


고지된 위도, 경도와 GPS에서 출력된 위도, 경도를 비교하여 정확성을 파악했다.

haversine 공식을 이용하여 계산했는데, 이 글에서는 이 때 측정한 결과를 따로 적진 않을 것이다.

왜냐면, GPS를 이때 처음 다뤄본 것이기 때문에 보조배터리로는 5V 2A가 원활히 공급되지 못하여 RTK fixed상태가 아니였을 확률이 높기 때문이다..


아무튼 이렇게 삽질을 해서 GPS 장비의 정확성을 파악하고자 노력하였다.

결과물이 없다는게 함정이지만..
